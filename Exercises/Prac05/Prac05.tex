\documentclass[letterpaper,12pt]{article}
\usepackage[spanish]{babel}
\spanishdecimal{.}
\selectlanguage{spanish}
\usepackage[spanish,onelanguage,ruled]{algorithm2e}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{subcaption}
\usepackage[top=2.5cm, bottom=2.5cm, left=2.5cm, right=2.5cm]{geometry}
\usepackage{hyperref}
\usepackage{verbatim}
\usepackage{amssymb}

\title{Práctica 5  \\ Cálculo de rutas utilizando A* y celdas de ocupación}
\author{M.I. Marco Negrete}
\date{Robots Móviles y Agentes Inteligentes}
\begin{document}
\renewcommand{\tablename}{Tabla}
\maketitle
\section*{Objetivos}
\begin{itemize}
\item A partir del mapa creado en la práctica 4, calcular una ruta mediante el algoritmo A*.
\item Suavizar la ruta utilizando descenso del gradiente. 
\item Publicar la ruta en un tópico y desplegarla en el visualizador \texttt{rviz}.
\end{itemize}

\section{Introducción}
\subsection{El algoritmo A*}
La planeación de rutas consiste en la obtención de un movimiento continuo que conecte una configuración inicial, con una final mientras se evaden obstáculos al mismo tiempo. Se parte del supuesto de que se dispone de una representación del ambiente en la cual hay información sobre el espacio navegable y el espacio ocupado por los obstáculos. En esta práctica se asume que el robot sólo se mueve sobre un plano y que se tiene una representación del ambiente que consiste en un mapa de celdas de ocupación (obtenido en la práctica 4). 

Una forma de encontrar una ruta es aplicando un algoritmo de búsqueda en grafos. En el caso de las celdas de ocupación, cada celda representa un nodo en el grafo y se considera que cada celda (nodo) está conectada únicamente con sus celdas vecinas. Para determinar los nodos vecinos se puede utilizar conectividad cuatro u ocho. En esta práctica se utilizará la conectivad cuatro. 

A* es un algoritmo de búsqueda que explora la ruta con el menor costo esperado. Para un nodo $n$, el costo esperado $f(n)$ se calcula como 
\[f(n) = g(n) + h(n)\]
donde $g(n)$ es el costo de la ruta desde el nodo origen hasta el nodo $n$ y $h(n)$ es una heurística que determina \textit{un} costo que se esperaría tener desde el mismo nodo $n$ hasta el nodo objetivo. Este costo esperado de hecho subestima el valor real, es decir, se debe cumplir que $h(n) \leq g(n)\quad \forall\; n \in\; Grafo$. 

En la búsqueda por A* se manejan dos conjuntos principales, uno llamado \textit{lista abierta} y el otro, \textit{lista cerrada}. La lista abierta contiene todos los nodos que han sido visitados pero no expandidos y la cerrada, aquellos que han sido visitados \textit{y} expandidos (también llamados nodos conocidos). El algoritmo \ref{alg:AStar} muestra los pasos en pseudocódigo para implementar A*. 
\begin{algorithm}
\DontPrintSemicolon
\KwData{Grafo, nodo inicial, nodo meta}
\KwResult{Ruta óptima expresada como una secuencia de nodos}
Cerrado $\leftarrow \emptyset$\;
Abierto $\leftarrow$ \{nodo\_inicial\}\;
previo(nodo\_inicial) $\leftarrow \varnothing$\;
\While{ Abierto $\neq\emptyset$ }
{
  nodo\_actual $\leftarrow$ nodo con el menor valor $f$ del conjunto $Abierto$\;
  Abierto $\leftarrow$ Abierto - \{nodo\_actual\}\;
  Cerrado $\leftarrow$ Cerrado $\cup$ \{nodo\_actual\}\;
  \If{nodo\_actual es nodo\_meta}
  {
    Anunciar éxito y salir de este ciclo\;
  }
  \ForEach{nodo\_vecino de nodo\_actual}
  {
    \If{nodo\_vecino $\in$ Cerrado}{Continuar con el siguiente nodo\_vecino}
    \eIf{nodo\_vecino $\in$ Abierto}
    {
      costo\_temporal $\leftarrow g(\textrm{nodo\_actual}) + d(\textrm{nodo\_actual, nodo\_vecino})$\;
      \If{costo\_temporal $<$ g(nodo\_vecino)}
      {
        $g(\textrm{nodo\_vecino})\leftarrow$ costo\_temporal\;
        $f(\textrm{nodo\_vecino})\leftarrow$ costo\_temporal + heurística(nodo\_vecino, nodo\_meta)\;
        previo(nodo\_vecino) $\leftarrow$ nodo\_actual\;
      }
    }
    {
      $g(\textrm{nodo\_vecino})\leftarrow g(\textrm{nodo\_actual}) + d(\textrm{nodo\_actual, nodo\_vecino})$\;
      $f(\textrm{nodo\_vecino})\leftarrow g\textrm{nodo\_vecino})$  + heurística(nodo\_vecino, nodo\_meta)\;
      previo(nodo\_vecino) $\leftarrow$ nodo\_actual\;
      Abierto $\leftarrow$ Abierto $\cup$ \{nodo\_vecino\}\; 
    }
  }
}
\eIf{nodo\_actual $\neq$ nodo\_meta}
{
  Anunciar falla\;
}
{
  RutaOptima $\leftarrow\emptyset$ \;
  \While{nodo\_actual $\neq\varnothing$ }
  {
    \textit{//El nodo actual se inserta al principio de la ruta}\;
    RutaÓptima $\leftarrow$ \{nodo\_actual\} $\cup$ RutaÓptima \;
    nodo\_actual $\leftarrow$ previo(nodo\_actual)\;
  }
  Regresar RutaÓptima
}
\caption{Búsqueda con A*}
\label{alg:AStar}
\end{algorithm}

\subsection{Suavizado de la ruta}
Dado que se está utilizando conectividad cuatro en el algoritmo de A*, la ruta calculada tendrá siempre vueltas con ángulos de 90°, lo cual no es deseable por varias razones: la primera de ellas es que la función de posición no es diferenciable en las esquinas, además, este tipo de vueltas ocasionan cambios bruscos en las señales de control, lo que finalmente ocasiona daños a los motores de la base móvil. Por otro lado, las restricciones de movimiento en algunos tipos de bases (como es el caso de los automóviles) pueden impedir ejecutar vueltas en ángulo recto.

Por lo anterior, es conveniente suavizar la ruta calculada por A* de modo que la nueva ruta sea lo suficientemente parecida a la original pero al mismo tiempo, lo suficientemente suave para evitar curvas muy pronunciadas. La figura ASDFASFASFD muestra un ejemplo de suavizado con dos casos extremos: la ruta azul es una ruta igual a la original, la verde es una ruta sin vueltas pero que ha dejado de ser una ruta útil, y la roja, que es un \textit{promedio ponderado} de las dos anteriores. 

Para poder obtener una ruta como la roja de la figura ASDFASDFA, plantearemos una función de costo que tome en cuenta el parecido con la ruta original y el \textit{nivel de suavizado} que se desee. Entre más suavizado, menor será el parecido con la ruta original y viceversa. La idea es encontrar el punto que 

\section{Desarrollo}
\textbf{Nota:} Para esta práctica se asume que el alumno ejecutó correctamente la práctica 4.


%Poner aquí el pseudogódigo
\subsection{Suavizado}
%Poner pseudocódigo de suavizado
\subsection{Visualización}
%Instrucciones para agregarla al rviz y ejemplo con imagen de lo que se espera obtener.
\section{Evaluación}
\begin{itemize}
\item La práctica se considera entregada si el mapa representa al ambiente de manera satisfactoria. 
\end{itemize}

\end{document}